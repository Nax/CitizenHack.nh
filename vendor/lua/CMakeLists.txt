include(ExternalProject)

set(LUA_VERSION            5.4.2)
set(LUA_INSTALL_DIR        "${CMAKE_BINARY_DIR}/_vendor")
set(LUA_INCLUDE_DIRECTORY  "${LUA_INSTALL_DIR}/include")
set(LUA_LIBRARY_DIRECTORY  "${LUA_INSTALL_DIR}/lib")

file(MAKE_DIRECTORY "${LUA_INCLUDE_DIRECTORY}")
file(MAKE_DIRECTORY "${LUA_LIBRARY_DIRECTORY}")

if (WIN32)
    set(LUA_IMPORTED_LOCATION_DEBUG    "${LUA_INSTALL_DIR}/bin/${CMAKE_SHARED_LIBRARY_PREFIX}lua54d${CMAKE_SHARED_LIBRARY_SUFFIX}")
    set(LUA_IMPORTED_IMPLIB_DEBUG      "${LUA_INSTALL_DIR}/lib/${CMAKE_IMPORT_LIBRARY_PREFIX}lua54d${CMAKE_IMPORT_LIBRARY_SUFFIX}")
    set(LUA_IMPORTED_LOCATION          "${LUA_INSTALL_DIR}/bin/${CMAKE_SHARED_LIBRARY_PREFIX}lua54${CMAKE_SHARED_LIBRARY_SUFFIX}")
    set(LUA_IMPORTED_IMPLIB            "${LUA_INSTALL_DIR}/lib/${CMAKE_IMPORT_LIBRARY_PREFIX}lua54${CMAKE_IMPORT_LIBRARY_SUFFIX}")
else()
    set(LUA_IMPORTED_LOCATION          "${LUA_INSTALL_DIR}/lib/${CMAKE_SHARED_LIBRARY_PREFIX}lua${CMAKE_SHARED_LIBRARY_SUFFIX}")
    set(LUA_IMPORTED_LOCATION_DEBUG    "${LUA_IMPORTED_LOCATION}")
endif()

ExternalProject_Add(
    ep_lua
    URL             "https://www.lua.org/ftp/lua-${LUA_VERSION}.tar.gz"
    PATCH_COMMAND   "${CMAKE_COMMAND}" -E copy_if_different "${CMAKE_CURRENT_SOURCE_DIR}/CMakeLists.txt.in" "<SOURCE_DIR>/CMakeLists.txt"
    INSTALL_DIR     "${LUA_INSTALL_DIR}"
    CMAKE_ARGS
        "-DCMAKE_BUILD_TYPE=$<CONFIG>"
        "-DCMAKE_INSTALL_PREFIX=<INSTALL_DIR>"
)

add_library(Lua::Lua SHARED IMPORTED GLOBAL)
set_target_properties(
    Lua::Lua
    PROPERTIES

    INTERFACE_INCLUDE_DIRECTORIES   "${LUA_INCLUDE_DIRECTORY}"
    IMPORTED_LOCATION_DEBUG         "${LUA_IMPORTED_LOCATION_DEBUG}"
    IMPORTED_LOCATION               "${LUA_IMPORTED_LOCATION}"
    IMPORTED_IMPLIB_DEBUG           "${LUA_IMPORTED_IMPLIB_DEBUG}"
    IMPORTED_IMPLIB                 "${LUA_IMPORTED_IMPLIB}"
)
add_dependencies(Lua::Lua ep_lua)
